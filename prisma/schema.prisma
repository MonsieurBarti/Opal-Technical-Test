generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for streaks tracking
model User {
  id         String   @id @default(uuid())
  timezone   String   // IANA timezone (e.g., "America/New_York")
  created_at DateTime @default(now())

  // Relations
  focus_sessions    FocusSession[]
  user_streak       UserStreak?
  friendships_as_1  Friendship[]   @relation("UserFriendships1")
  friendships_as_2  Friendship[]   @relation("UserFriendships2")

  @@map("users")
}

// Focus session records (immutable event log)
model FocusSession {
  session_id       String   @id // Client-provided idempotency key
  user_id          String
  start_time       DateTime // UTC
  end_time         DateTime // UTC
  duration_minutes Int
  timezone         String   // User's timezone when session was recorded
  created_at       DateTime @default(now())

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  // Performance: Query sessions by user and time range
  @@index([user_id, start_time])
  @@map("focus_sessions")
}

// Denormalized streak aggregate (read optimization)
model UserStreak {
  user_id              String   @id
  current_streak       Int      @default(0)
  longest_streak       Int      @default(0)
  last_qualified_date  DateTime? // Last date user had â‰¥30 min focus
  qualified_days_count Int      @default(0) // Total qualified days (for leaderboard)
  updated_at           DateTime @updatedAt

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_streaks")
}

// Bidirectional friendships
model Friendship {
  id         String   @id @default(uuid())
  user_id_1  String
  user_id_2  String
  created_at DateTime @default(now())

  // Relations
  user_1 User @relation("UserFriendships1", fields: [user_id_1], references: [id], onDelete: Cascade)
  user_2 User @relation("UserFriendships2", fields: [user_id_2], references: [id], onDelete: Cascade)

  // Ensure bidirectional uniqueness (prevent duplicate friendships)
  @@unique([user_id_1, user_id_2])
  // Performance: Query friendships by user
  @@index([user_id_1])
  @@index([user_id_2])
  @@map("friendships")
}
